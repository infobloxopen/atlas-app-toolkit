package requestid

import (
	"context"
	"testing"

	"google.golang.org/grpc"
	"google.golang.org/grpc/metadata"
	"google.golang.org/grpc/transport"
)

type testRequest struct{}

type testResponse struct{}

type mockStream struct {
	ctx context.Context
}

func (mockStream) SetHeader(metadata.MD) error {
	return nil
}

func (mockStream) SendHeader(metadata.MD) error {
	return nil
}

func (mockStream) SetTrailer(metadata.MD) {}

func (m mockStream) Context() context.Context {
	return m.ctx
}

func (mockStream) SendMsg(m interface{}) error {
	return nil
}

func (mockStream) RecvMsg(m interface{}) error {
	return nil
}

func DummyContextWithServerTransportStream() context.Context {
	expectedStream := &transport.Stream{}
	return grpc.NewContextWithServerTransportStream(context.Background(), expectedStream)
}

func TestUnaryServerInterceptorWithoutRequestId(t *testing.T) {
	handler := func(ctx context.Context, req interface{}) (interface{}, error) {
		reqID, exists := FromContext(ctx)
		if exists && reqID == "" {
			t.Errorf("requestId must be generated by interceptor")
		}
		return &testResponse{}, nil
	}
	ctx := DummyContextWithServerTransportStream()
	_, err := UnaryServerInterceptor()(ctx, testRequest{}, nil, handler)
	if err != nil {
		t.Fatalf("unexpected error: %v", err)
	}
}

func TestUnaryServerInterceptorWithDummyRequestId(t *testing.T) {
	dummyRequestID := newRequestID()
	handler := func(ctx context.Context, req interface{}) (interface{}, error) {
		reqID, exists := FromContext(ctx)
		if !exists || reqID != dummyRequestID {
			t.Errorf("expected requestID: %q, returned requestId: %q", dummyRequestID, reqID)
		}
		return &testResponse{}, nil
	}
	ctx := DummyContextWithServerTransportStream()
	md := metadata.Pairs(DefaultRequestIDKey, dummyRequestID)
	newCtx := metadata.NewIncomingContext(ctx, md)
	_, err := UnaryServerInterceptor()(newCtx, testRequest{}, nil, handler)
	if err != nil {
		t.Fatalf("unexpected error: %v", err)
	}
}

func TestStreamServerInterceptorWithoutRequestId(t *testing.T) {
	handler := func(srv interface{}, stream grpc.ServerStream) error {
		reqID, exists := FromContext(stream.Context())
		if exists && reqID == "" {
			t.Errorf("requestId must be generated by interceptor")
		}
		return nil
	}
	ctx := DummyContextWithServerTransportStream()
	err := StreamServerInterceptor()(testRequest{}, mockStream{ctx}, nil, handler)
	if err != nil {
		t.Fatalf("unexpected error: %v", err)
	}
}

func TestStreamServerInterceptorWithDummyRequestId(t *testing.T) {
	dummyRequestID := newRequestID()
	handler := func(srv interface{}, stream grpc.ServerStream) error {
		reqID, exists := FromContext(stream.Context())
		if !exists || reqID != dummyRequestID {
			t.Errorf("expected requestID: %q, returned requestId: %q", dummyRequestID, reqID)
		}
		return nil
	}
	ctx := DummyContextWithServerTransportStream()
	md := metadata.Pairs(DefaultRequestIDKey, dummyRequestID)
	newCtx := metadata.NewIncomingContext(ctx, md)
	err := StreamServerInterceptor()(testRequest{}, mockStream{newCtx}, nil, handler)
	if err != nil {
		t.Fatalf("unexpected error: %v", err)
	}
}
